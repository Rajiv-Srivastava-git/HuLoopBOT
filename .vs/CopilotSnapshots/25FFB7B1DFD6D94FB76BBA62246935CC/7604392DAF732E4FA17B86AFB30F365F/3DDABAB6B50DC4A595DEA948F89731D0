using HuLoopBOT.Models;
using Microsoft.Win32;
using HuLoopBOT.Utilities;

namespace HuLoopBOT.Services;

public class RdpService
{
    public OperationResult PreventTimeout()
    {
        try
        {
            var registryPath = @"HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services";

            Logger.LogVerbose($"Starting PreventTimeout operation");
            Logger.LogVerbose($"Registry path: {registryPath}");

            // Disable idle timeout
            Logger.LogVerbose("Setting MaxIdleTime = 0");
            Registry.SetValue(registryPath, "MaxIdleTime", 0, RegistryValueKind.DWord);

            // Disable disconnected session timeout
            Logger.LogVerbose("Setting MaxDisconnectionTime = 0");
            Registry.SetValue(registryPath, "MaxDisconnectionTime", 0, RegistryValueKind.DWord);

            // Set session time limit to unlimited
            Logger.LogVerbose("Setting MaxConnectionTime = 0");
            Registry.SetValue(registryPath, "MaxConnectionTime", 0, RegistryValueKind.DWord);

            // Disable automatic reconnection timeout
            Logger.LogVerbose("Setting MaxAutoreconnectTime = 0");
            Registry.SetValue(registryPath, "fResetBroken", 0, RegistryValueKind.DWord);

            Logger.LogInformation("RDP timeout and disconnected session limits disabled successfully");
            Logger.LogVerbose("PreventTimeout operation completed");

            return OperationResult.Ok("RDP timeout and disconnected session limits disabled");
        }
        catch (Exception ex)
        {
            Logger.LogError("Failed to disable RDP timeout", ex);
            return OperationResult.Fail($"Failed to disable RDP timeout: {ex.Message}");
        }
    }

    public OperationResult DisableDisconnectedSessionTimeout()
    {
        try
        {
            Logger.LogVerbose("Starting DisableDisconnectedSessionTimeout operation");

            var registryPath = @"SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services";

            using (var key = Registry.LocalMachine.CreateSubKey(registryPath))
            {
                if (key != null)
                {
                    // Set disconnected session timeout to never (0 = unlimited)
                    key.SetValue("MaxDisconnectionTime", 0, RegistryValueKind.DWord);

                    // Set idle session timeout to never
                    key.SetValue("MaxIdleTime", 0, RegistryValueKind.DWord);

                    // Set connection timeout to never
                    key.SetValue("MaxConnectionTime", 0, RegistryValueKind.DWord);

                    Logger.LogInformation("Disconnected session timeout set to Never");
                }
            }

            Logger.LogVerbose("DisableDisconnectedSessionTimeout operation completed");
            return OperationResult.Ok("Disconnected session timeout set to Never");
        }
        catch (Exception ex)
        {
            Logger.LogError("Failed to disable disconnected session timeout", ex);
            return OperationResult.Fail($"Failed to disable disconnected session timeout: {ex.Message}");
        }
    }
}
