using HuLoopBOT.Services;
using HuLoopBOT.Utilities;
using System.Diagnostics;

namespace HuLoopBOT;

public partial class MainForm : Form
{
    private readonly bool _isAdmin;
    private RdpSessionMonitor? _rdpMonitor;
    private readonly UserManagementService _userService;
    private LocalUser? _selectedUser;

    public MainForm()
    {
        InitializeComponent();

        _isAdmin = AdminService.IsAdmin();
        _userService = new UserManagementService();

        UpdateAdminStatus();
        ConfigureButtonsForPrivilegeLevel();
        ConfigureRestartButton();
        LoadUsers();

        // Initialize RDP session monitor if admin
        if (_isAdmin)
        {
            InitializeRdpMonitor();
        }
    }

    private void cmbUsers_SelectedIndexChanged(object sender, EventArgs e)
    {
        if (cmbUsers.SelectedItem is LocalUser selectedUser)
        {
            _selectedUser = selectedUser;
            Logger.LogInformation($"User selected: {selectedUser.Username} ({selectedUser.FullName})");
            UpdateUserSelectionStatus();
        }
    }

    private void btnRefreshUsers_Click(object sender, EventArgs e)
    {
        RefreshUserList();
    }

    private void LoadUsers()
    {
        try
        {
            Logger.LogVerbose("Loading local users into dropdown");

            cmbUsers.Items.Clear();
            cmbUsers.DisplayMember = "DisplayName";

            var users = _userService.GetLocalUsers();

            if (users.Count == 0)
            {
                Logger.LogWarning("No local users found");
                cmbUsers.Items.Add("No users found");
                cmbUsers.Enabled = false;
                return;
            }

            // Add all enabled users
            foreach (var user in users.Where(u => u.IsEnabled))
            {
                cmbUsers.Items.Add(user);
            }

            Logger.LogInformation($"Loaded {cmbUsers.Items.Count} enabled users into dropdown");

            // Auto-select current user
            var currentUser = _userService.GetCurrentUser();
            if (currentUser != null)
            {
                for (int i = 0; i < cmbUsers.Items.Count; i++)
                {
                    if (cmbUsers.Items[i] is LocalUser user &&
                        user.Username.Equals(currentUser.Username, StringComparison.OrdinalIgnoreCase))
                    {
                        cmbUsers.SelectedIndex = i;
                        Logger.LogVerbose($"Auto-selected current user: {currentUser.Username}");
                        break;
                    }
                }
            }

            // If no selection, select first user
            if (cmbUsers.SelectedIndex == -1 && cmbUsers.Items.Count > 0)
            {
                cmbUsers.SelectedIndex = 0;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError("Failed to load users", ex);
            MessageBox.Show(
      $"Failed to load user list:\n\n{ex.Message}",
              "Error Loading Users",
        MessageBoxButtons.OK,
          MessageBoxIcon.Error);
        }
    }

    private void RefreshUserList()
    {
        try
        {
            Logger.LogInformation("Refreshing user list");

            btnRefreshUsers.Enabled = false;
            btnRefreshUsers.Text = "...";

            Application.DoEvents();

            LoadUsers();

            btnRefreshUsers.Text = "\u27F3";
            btnRefreshUsers.Enabled = true;

            Logger.LogInformation("User list refreshed successfully");
        }
        catch (Exception ex)
        {
            Logger.LogError("Failed to refresh user list", ex);
            btnRefreshUsers.Text = "\u27F3";
            btnRefreshUsers.Enabled = true;
        }
    }

    private void UpdateUserSelectionStatus()
    {
        if (_selectedUser != null)
        {
            string currentUserName = Environment.UserName;
            bool isCurrentUser = _selectedUser.Username.Equals(currentUserName, StringComparison.OrdinalIgnoreCase);

            if (!isCurrentUser && _isAdmin)
            {
                Logger.LogVerbose($"Selected user ({_selectedUser.Username}) is different from current user ({currentUserName})");
            }
        }
    }

    private void InitializeRdpMonitor()
    {
        try
        {
            Logger.LogVerbose("Initializing RDP session monitor");

            _rdpMonitor = new RdpSessionMonitor();
            _rdpMonitor.AutoTransferOnDisconnect = true;

            // Start monitoring after form handle is created
            if (Handle != IntPtr.Zero)
            {
                bool started = _rdpMonitor.StartMonitoring(Handle);
                if (started)
                {
                    Logger.LogInformation("RDP session auto-transfer monitoring is active");
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError("Failed to initialize RDP session monitor", ex);
        }
    }

    protected override void OnHandleCreated(EventArgs e)
    {
        base.OnHandleCreated(e);

        // Start RDP monitoring when handle is available
        if (_isAdmin && _rdpMonitor != null && !_rdpMonitor.IsMonitoring)
        {
            _rdpMonitor.StartMonitoring(Handle);
        }
    }

    protected override void WndProc(ref Message m)
    {
        const int WM_WTSSESSION_CHANGE = 0x02B1;

        // Process session change messages
        if (m.Msg == WM_WTSSESSION_CHANGE && _rdpMonitor != null)
        {
            int eventType = m.WParam.ToInt32();
            int sessionId = m.LParam.ToInt32();

            _rdpMonitor.ProcessSessionChange(eventType, sessionId);
        }

        base.WndProc(ref m);
    }

    protected override void OnFormClosing(FormClosingEventArgs e)
    {
        // Stop RDP monitoring when form is closing
        if (_rdpMonitor != null && _rdpMonitor.IsMonitoring)
        {
            _rdpMonitor.StopMonitoring(Handle);
            _rdpMonitor.Dispose();
        }

        base.OnFormClosing(e);
    }

    private void UpdateAdminStatus()
    {
        if (_isAdmin)
        {
            lblAdminStatus.Text = "\u2713 Running as Administrator"; // ✓
            lblAdminStatus.ForeColor = Color.Green;
            lblInfo.Text = "All operations are available. RDP auto-transfer is active.";
            lblInfo.ForeColor = Color.Green;
        }
        else
        {
            lblAdminStatus.Text = "\u26A0 Not Administrator - Limited Features"; // ⚠
            lblAdminStatus.ForeColor = Color.Orange;
            lblInfo.Text = "Administrator privileges are required to modify system settings.";
            lblInfo.ForeColor = Color.Gray;
        }

        // Ensure proper font for Unicode characters
        lblAdminStatus.Font = new Font("Segoe UI", 10F, FontStyle.Bold);
    }

    private void ConfigureRestartButton()
    {
        // Only show restart button for non-admin users
        btnRestartAsAdmin.Visible = !_isAdmin;

        if (_isAdmin)
        {
            // Adjust layout when restart button is hidden
            btnDisableSleep.Location = new Point(20, 135);
            btnDisableLock.Location = new Point(20, 180);
            btnPreventRdpTimeout.Location = new Point(20, 225);
            btnTransferSession.Location = new Point(20, 270);
            ClientSize = new Size(400, 325);
        }
    }

    private void ConfigureButtonsForPrivilegeLevel()
    {
        if (!_isAdmin)
        {
            // Disable operation buttons for non-admin users
            btnDisableSleep.Enabled = false;
            btnDisableLock.Enabled = false;
            btnPreventRdpTimeout.Enabled = false;
            btnTransferSession.Enabled = false;

            // Update button text to show admin required
            btnDisableSleep.Text = "Disable Sleep (Admin Required)";
            btnDisableLock.Text = "Disable Lock Screen (Admin Required)";
            btnPreventRdpTimeout.Text = "Prevent RDP Timeout (Admin Required)";
            btnTransferSession.Text = "Transfer Session (Admin Required)";

            Logger.LogInformation("UI loaded in non-admin mode - operations disabled");
        }
        else
        {
            // Update Transfer Session button text to indicate auto mode
            btnTransferSession.Text = "Transfer Session (Manual)";

            Logger.LogInformation("UI loaded in admin mode - all operations enabled");
        }
    }

    private void btnDisableSleep_Click(object sender, EventArgs e)
    {
        if (!_isAdmin)
        {
            ShowAdminRequiredMessage();
            return;
        }

        if (_selectedUser == null)
        {
            ShowNoUserSelectedMessage();
            return;
        }

        try
        {
            var result = new PowerService().DisableSleep();
            ShowResult(result.Success, result.Message);
        }
        catch (Exception ex)
        {
            Logger.LogError("Error in btnDisableSleep_Click", ex);
            ShowResult(false, $"Error: {ex.Message}");
        }
    }

    private void btnDisableLock_Click(object sender, EventArgs e)
    {
        if (!_isAdmin)
        {
            ShowAdminRequiredMessage();
            return;
        }

        if (_selectedUser == null)
        {
            ShowNoUserSelectedMessage();
            return;
        }

        try
        {
            var result = new LockService().DisableLockScreen();
            ShowResult(result.Success, result.Message);
        }
        catch (Exception ex)
        {
            Logger.LogError("Error in btnDisableLock_Click", ex);
            ShowResult(false, $"Error: {ex.Message}");
        }
    }

    private void btnPreventRdpTimeout_Click(object sender, EventArgs e)
    {
        if (!_isAdmin)
        {
            ShowAdminRequiredMessage();
            return;
        }

        if (_selectedUser == null)
        {
            ShowNoUserSelectedMessage();
            return;
        }

        try
        {
            var result = new RdpService().PreventTimeout();
            ShowResult(result.Success, result.Message);
        }
        catch (Exception ex)
        {
            Logger.LogError("Error in btnPreventRdpTimeout_Click", ex);
            ShowResult(false, $"Error: {ex.Message}");
        }
    }

    private void btnTransferSession_Click(object sender, EventArgs e)
    {
        if (!_isAdmin)
        {
            ShowAdminRequiredMessage();
         return;
        }

        if (_selectedUser == null)
        {
            ShowNoUserSelectedMessage();
            return;
    }

        // Manual transfer - user can still trigger it manually if needed
      var result = MessageBox.Show(
$"RDP session transfer is automatically triggered on disconnect.\n\n" +
        $"Do you want to manually transfer the session for user '{_selectedUser.Username}' to console now?",
"Manual Session Transfer",
    MessageBoxButtons.YesNo,
    MessageBoxIcon.Question);

        if (result == DialogResult.Yes)
        {
            try
    {
     // Get active sessions for the selected user
    var sessionUsers = _userService.GetActiveSessionUsers();
         var userSession = sessionUsers.FirstOrDefault(s =>
    s.Username.Equals(_selectedUser.Username, StringComparison.OrdinalIgnoreCase));

            if (userSession != null)
       {
       Logger.LogInformation($"Transferring session {userSession.SessionId} for user {_selectedUser.Username}");
       var transferResult = new SessionTransferService().Transfer(userSession.SessionId);
    ShowResult(transferResult.Success, transferResult.Message);
   }
     else
                {
    ShowResult(false, $"No active session found for user '{_selectedUser.Username}'");
    }
 }
    catch (Exception ex)
  {
     Logger.LogError("Error in btnTransferSession_Click", ex);
         ShowResult(false, $"Error: {ex.Message}");
    }
   }
    }

    private void btnEnableAutoLogin_Click(object sender, EventArgs e)
    {
      if (!_isAdmin)
        {
            ShowAdminRequiredMessage();
          return;
        }

        if (_selectedUser == null)
    {
            ShowNoUserSelectedMessage();
            return;
        }

    try
        {
    // Show password input dialog
        using var passwordForm = new PasswordInputForm(_selectedUser.Username);
            if (passwordForm.ShowDialog() == DialogResult.OK)
  {
           var service = new AutoLoginService();
      var result = service.EnableAutoLogin(_selectedUser.Username, passwordForm.Password);
      ShowResult(result.Success, result.Message);
   }
        }
      catch (Exception ex)
        {
    Logger.LogError("Error in btnEnableAutoLogin_Click", ex);
            ShowResult(false, $"Error: {ex.Message}");
        }
    }

    private void btnDisableScreenSaver_Click(object sender, EventArgs e)
    {
    if (!_isAdmin)
   {
            ShowAdminRequiredMessage();
    return;
        }

        if (_selectedUser == null)
    {
     ShowNoUserSelectedMessage();
        return;
        }

    try
  {
   var service = new ScreenSaverService();
            var result = service.DisableScreenSaverForUser(_selectedUser.Username);
            ShowResult(result.Success, result.Message);
        }
        catch (Exception ex)
        {
    Logger.LogError("Error in btnDisableScreenSaver_Click", ex);
   ShowResult(false, $"Error: {ex.Message}");
        }
    }

 private void btnConfigureAll_Click(object sender, EventArgs e)
    {
        if (!_isAdmin)
        {
            ShowAdminRequiredMessage();
          return;
      }

        if (_selectedUser == null)
 {
  ShowNoUserSelectedMessage();
     return;
        }

        var confirmResult = MessageBox.Show(
  $"This will configure ALL settings for user '{_selectedUser.Username}':\n\n" +
   "1. Enable Auto Login (will prompt for password)\n" +
 "2. Disable Sleep & Hibernate\n" +
     "3. Disable Screen Timeout\n" +
   "4. Disable Lock Screen\n" +
      "5. Disable Screen Saver\n" +
            "6. Disable RDP Timeouts (Idle, Disconnected, Connection)\n\n" +
            "Do you want to continue?",
  "Configure All Settings",
            MessageBoxButtons.YesNo,
      MessageBoxIcon.Question);

      if (confirmResult != DialogResult.Yes)
      return;

        try
        {
            var results = new List<string>();
      var errors = new List<string>();

            // 1. Enable Auto Login
     using (var passwordForm = new PasswordInputForm(_selectedUser.Username))
          {
       if (passwordForm.ShowDialog() == DialogResult.OK)
      {
           var autoLoginService = new AutoLoginService();
    var result = autoLoginService.EnableAutoLogin(_selectedUser.Username, passwordForm.Password);
if (result.Success)
      results.Add("✓ Auto Login enabled");
   else
       errors.Add($"✗ Auto Login: {result.Message}");
         }
          else
      {
errors.Add("✗ Auto Login: Password not provided");
  }
         }

     // 2. Disable Sleep & Hibernate
  var powerService = new PowerService();
 var sleepResult = powerService.DisableSleep();
            if (sleepResult.Success)
           results.Add("✓ Sleep & Hibernate disabled");
     else
    errors.Add($"✗ Sleep: {sleepResult.Message}");

          // 3. Disable Screen Timeout
            var timeoutResult = powerService.DisableScreenTimeout();
            if (timeoutResult.Success)
    results.Add("✓ Screen Timeout disabled");
   else
    errors.Add($"✗ Screen Timeout: {timeoutResult.Message}");

     // 4. Disable Lock Screen
    var lockService = new LockService();
            var lockResult = lockService.DisableLockScreen();
        if (lockResult.Success)
     results.Add("✓ Lock Screen disabled");
 else
      errors.Add($"✗ Lock Screen: {lockResult.Message}");

         // 5. Disable Screen Saver
    var screenSaverService = new ScreenSaverService();
var screenSaverResult = screenSaverService.DisableScreenSaverForUser(_selectedUser.Username);
       if (screenSaverResult.Success)
       results.Add("✓ Screen Saver disabled");
            else
   errors.Add($"✗ Screen Saver: {screenSaverResult.Message}");

    // 6. Disable RDP Timeouts
            var rdpService = new RdpService();
  var rdpResult = rdpService.PreventTimeout();
         if (rdpResult.Success)
                results.Add("✓ RDP Timeouts disabled (Idle, Disconnected, Connection)");
            else
            errors.Add($"✗ RDP Timeouts: {rdpResult.Message}");

      // Show summary
            var summary = "Configuration Complete!\n\n";
         
            if (results.Count > 0)
     {
       summary += "Successful Operations:\n" + string.Join("\n", results) + "\n\n";
    }

  if (errors.Count > 0)
            {
   summary += "Failed Operations:\n" + string.Join("\n", errors);
     }

 var icon = errors.Count == 0 ? MessageBoxIcon.Information : MessageBoxIcon.Warning;
  MessageBox.Show(summary, "Configuration Summary", MessageBoxButtons.OK, icon);

      Logger.LogInformation($"Configure All completed for user {_selectedUser.Username}. Success: {results.Count}, Failures: {errors.Count}");
     }
        catch (Exception ex)
        {
         Logger.LogError("Error in btnConfigureAll_Click", ex);
    ShowResult(false, $"Error: {ex.Message}");
    }
    }

    private void ShowResult(bool success, string message)
    {
        var icon = success ? MessageBoxIcon.Information : MessageBoxIcon.Error;
        var title = success ? "Success" : "Error";

        Logger.Log(message);
        MessageBox.Show(message, title, MessageBoxButtons.OK, icon);
    }

    private void ShowAdminRequiredMessage()
    {
        var result = MessageBox.Show(
           "Administrator privileges are required for this operation.\n\n" +
               "Would you like to restart the application as Administrator?",
                    "Administrator Required",
           MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning);

        if (result == DialogResult.Yes)
        {
            RestartAsAdmin();
        }
    }

    private void ShowNoUserSelectedMessage()
    {
        MessageBox.Show(
     "Please select a user from the dropdown list before performing this operation.",
            "No User Selected",
        MessageBoxButtons.OK,
  MessageBoxIcon.Warning);
    }

    private void RestartAsAdmin()
    {
        try
        {
            Logger.LogInformation("User requested to restart application with elevated privileges");

            var psi = new ProcessStartInfo
            {
                FileName = Application.ExecutablePath,
                UseShellExecute = true,
                Verb = "runas"
            };

            Logger.LogVerbose($"Starting elevated process: {psi.FileName}");

            Process.Start(psi);

            Logger.LogInformation("Elevated process started, closing current instance");
            Application.Exit();
        }
        catch (System.ComponentModel.Win32Exception ex)
        {
            if (ex.NativeErrorCode == 1223) // User cancelled UAC
            {
                Logger.LogWarning("User cancelled UAC elevation prompt");
                MessageBox.Show(
               "Elevation cancelled. The application will continue in limited mode.",
            "Cancelled",
          MessageBoxButtons.OK,
                  MessageBoxIcon.Information);
            }
            else
            {
                Logger.LogError($"Failed to restart as admin. Error Code: {ex.NativeErrorCode}", ex);
                MessageBox.Show(
                $"Failed to restart with elevated privileges.\n\nError: {ex.Message}",
                   "Error",
                     MessageBoxButtons.OK,
                      MessageBoxIcon.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError("Unexpected error during restart as admin", ex);
            MessageBox.Show(
    $"An unexpected error occurred:\n\n{ex.Message}",
     "Error",
      MessageBoxButtons.OK,
      MessageBoxIcon.Error);
        }
    }
}
