using HuLoopBOT.Models;
using HuLoopBOT.Utilities;
using Microsoft.Win32;
using System.Runtime.InteropServices;
using System.Security;

namespace HuLoopBOT.Services;

/// <summary>
/// Service for managing Windows Auto Login functionality
/// </summary>
public class AutoLoginService
{
    [DllImport("advapi32.dll", SetLastError = true, CharSet = CharSet.Unicode)]
    private static extern bool LogonUser(
  string lpszUsername,
        string? lpszDomain,
 string lpszPassword,
        int dwLogonType,
        int dwLogonProvider,
   out IntPtr phToken);

    [DllImport("kernel32.dll", SetLastError = true)]
    [return: MarshalAs(UnmanagedType.Bool)]
    private static extern bool CloseHandle(IntPtr hObject);

    private const int LOGON32_LOGON_INTERACTIVE = 2;
    private const int LOGON32_PROVIDER_DEFAULT = 0;

    /// <summary>
    /// Enables auto login for the specified user
    /// </summary>
    /// <param name="username">Username (can include domain: DOMAIN\Username)</param>
  /// <param name="password">User's password (required for auto login)</param>
    /// <returns>Operation result</returns>
 public OperationResult EnableAutoLogin(string username, SecureString password)
    {
        try
        {
        Logger.LogVerbose($"Starting EnableAutoLogin operation for user: {username}");

   // Parse domain and username
  string domain = "";
         string user = username;

   if (username.Contains('\\'))
   {
   var parts = username.Split('\\');
  domain = parts[0];
       user = parts[1];
      }
  else
      {
     domain = Environment.MachineName; // Use local machine as domain
    }

       Logger.LogVerbose($"Parsed - Domain: '{domain}', User: '{user}'");

      // Validate credentials before setting auto login
     if (!ValidateCredentials(user, domain, password))
       {
    Logger.LogError($"Invalid credentials provided for user: {username}", null);
     return OperationResult.Fail("Invalid username or password");
     }

     Logger.LogInformation($"Credentials validated successfully for {domain}\\{user}");

  // Set auto login in registry
   var winlogonPath = @"SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon";
      Logger.LogVerbose($"Opening registry key: HKLM\\{winlogonPath}");
 
     using (var key = Registry.LocalMachine.CreateSubKey(winlogonPath))
      {
    if (key == null)
    {
    Logger.LogError("Failed to open Winlogon registry key", null);
        return OperationResult.Fail("Failed to access registry");
     }

    Logger.LogVerbose("Registry key opened successfully");

  // Enable auto login
 Logger.LogVerbose("Setting AutoAdminLogon = '1'");
     key.SetValue("AutoAdminLogon", "1", RegistryValueKind.String);
   
     // Set username
     Logger.LogVerbose($"Setting DefaultUserName = '{user}'");
         key.SetValue("DefaultUserName", user, RegistryValueKind.String);
   
        // Set domain (empty string for local accounts)
     Logger.LogVerbose($"Setting DefaultDomainName = '{domain}'");
     key.SetValue("DefaultDomainName", domain, RegistryValueKind.String);
      
    // Set password (stored encrypted by Windows)
       var plainPassword = ConvertToUnsecureString(password);
           Logger.LogVerbose($"Setting DefaultPassword (length: {plainPassword.Length} characters)");
      key.SetValue("DefaultPassword", plainPassword, RegistryValueKind.String);
      
   // Disable legal notice prompt (optional, but recommended for auto login)
     Logger.LogVerbose("Clearing legal notice prompts");
     key.SetValue("LegalNoticeCaption", "", RegistryValueKind.String);
  key.SetValue("LegalNoticeText", "", RegistryValueKind.String);

   // Verify values were set
            Logger.LogVerbose("Verifying registry values were set correctly");
         var verifyAutoAdminLogon = key.GetValue("AutoAdminLogon") as string;
                var verifyUsername = key.GetValue("DefaultUserName") as string;
      var verifyDomain = key.GetValue("DefaultDomainName") as string;
                var verifyPassword = key.GetValue("DefaultPassword") as string;

 Logger.LogVerbose($"Verification - AutoAdminLogon: '{verifyAutoAdminLogon}'");
   Logger.LogVerbose($"Verification - DefaultUserName: '{verifyUsername}'");
     Logger.LogVerbose($"Verification - DefaultDomainName: '{verifyDomain}'");
   Logger.LogVerbose($"Verification - DefaultPassword: '{(string.IsNullOrEmpty(verifyPassword) ? "EMPTY" : $"SET ({verifyPassword.Length} chars)")}'");

    if (verifyAutoAdminLogon != "1" || string.IsNullOrEmpty(verifyUsername) || string.IsNullOrEmpty(verifyPassword))
        {
      Logger.LogError("Registry values verification failed - values not persisted correctly", null);
return OperationResult.Fail("Failed to persist auto login settings. Registry values not saved correctly.");
          }

   Logger.LogInformation($"Auto login enabled for user: {domain}\\{user}");
       Logger.LogInformation("Registry values verified and persisted successfully");
 }

 Logger.LogVerbose("EnableAutoLogin operation completed");
  return OperationResult.Ok($"Auto login enabled for {username}");
        }
        catch (Exception ex)
    {
   Logger.LogError($"Failed to enable auto login for user {username}", ex);
       return OperationResult.Fail($"Failed to enable auto login: {ex.Message}");
 }
    }

    /// <summary>
    /// Disables auto login
    /// </summary>
    public OperationResult DisableAutoLogin()
    {
     try
   {
            Logger.LogVerbose("Starting DisableAutoLogin operation");

            var winlogonPath = @"SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon";
    
       using (var key = Registry.LocalMachine.CreateSubKey(winlogonPath))
 {
      if (key == null)
             {
   Logger.LogError("Failed to open Winlogon registry key", null);
  return OperationResult.Fail("Failed to access registry");
       }

    // Disable auto login
       key.SetValue("AutoAdminLogon", "0", RegistryValueKind.String);
        
 // Clear password for security
    try
  {
  key.DeleteValue("DefaultPassword", false);
  }
      catch
     {
       // Password value may not exist
   }

 Logger.LogInformation("Auto login disabled");
     }

     Logger.LogVerbose("DisableAutoLogin operation completed");
       return OperationResult.Ok("Auto login disabled");
     }
 catch (Exception ex)
  {
 Logger.LogError("Failed to disable auto login", ex);
   return OperationResult.Fail($"Failed to disable auto login: {ex.Message}");
        }
    }

    /// <summary>
    /// Checks if auto login is currently enabled
    /// </summary>
    public bool IsAutoLoginEnabled()
    {
        try
        {
        var winlogonPath = @"SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon";
         
            using (var key = Registry.LocalMachine.OpenSubKey(winlogonPath))
            {
     if (key == null) return false;

       var autoLogin = key.GetValue("AutoAdminLogon") as string;
    return autoLogin == "1";
     }
        }
   catch (Exception ex)
    {
  Logger.LogVerbose($"Error checking auto login status: {ex.Message}");
            return false;
   }
}

    /// <summary>
    /// Gets the currently configured auto login username
    /// </summary>
    public string? GetAutoLoginUser()
    {
 try
   {
   var winlogonPath = @"SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon";
         
   using (var key = Registry.LocalMachine.OpenSubKey(winlogonPath))
            {
  if (key == null) return null;

 var username = key.GetValue("DefaultUserName") as string;
       var domain = key.GetValue("DefaultDomainName") as string;

       if (string.IsNullOrEmpty(username))
         return null;

      if (!string.IsNullOrEmpty(domain) && domain != Environment.MachineName)
    {
   return $"{domain}\\{username}";
       }

       return username;
       }
        }
        catch (Exception ex)
    {
            Logger.LogVerbose($"Error getting auto login user: {ex.Message}");
     return null;
    }
    }

    /// <summary>
    /// Validates user credentials
    /// </summary>
    private bool ValidateCredentials(string username, string? domain, SecureString password)
    {
        IntPtr token = IntPtr.Zero;
   try
        {
      var plainPassword = ConvertToUnsecureString(password);
            
   bool result = LogonUser(
          username,
    string.IsNullOrEmpty(domain) ? null : domain,
plainPassword,
  LOGON32_LOGON_INTERACTIVE,
  LOGON32_PROVIDER_DEFAULT,
      out token);

   if (result)
     {
         Logger.LogVerbose($"Credentials validated successfully for user: {username}");
    }
  else
    {
       Logger.LogVerbose($"Credential validation failed for user: {username}");
          }

   return result;
 }
        catch (Exception ex)
   {
Logger.LogVerbose($"Error validating credentials: {ex.Message}");
   return false;
        }
  finally
  {
 if (token != IntPtr.Zero)
     {
     CloseHandle(token);
            }
        }
    }

    /// <summary>
    /// Converts SecureString to plain string (use carefully!)
    /// </summary>
    private string ConvertToUnsecureString(SecureString securePassword)
    {
        IntPtr unmanagedString = IntPtr.Zero;
   try
        {
   unmanagedString = Marshal.SecureStringToGlobalAllocUnicode(securePassword);
            return Marshal.PtrToStringUni(unmanagedString) ?? "";
        }
        finally
   {
   if (unmanagedString != IntPtr.Zero)
       {
   Marshal.ZeroFreeGlobalAllocUnicode(unmanagedString);
    }
        }
    }
}
