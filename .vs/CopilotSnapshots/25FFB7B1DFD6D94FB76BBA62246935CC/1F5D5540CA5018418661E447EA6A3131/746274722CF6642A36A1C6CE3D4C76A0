using HuLoopBOT.Utilities;
using Microsoft.Win32;
using System.Diagnostics;
using System.Security.Principal;

namespace HuLoopBOT.Services;

/// <summary>
/// Service to verify and diagnose system configuration status
/// </summary>
public class SystemVerificationService
{
    public class VerificationResult
    {
        public string Setting { get; set; } = "";
        public bool IsConfigured { get; set; }
        public string Status { get; set; } = "";
        public string Details { get; set; } = "";
    }

    /// <summary>
    /// Verify all machine readiness settings for a specific user
    /// </summary>
    /// <param name="username">Username to verify (can include domain: DOMAIN\Username)</param>
    public List<VerificationResult> VerifyAllSettings(string? username = null)
    {
        var results = new List<VerificationResult>();

        results.Add(VerifyAutoLogin(username));
     results.Add(VerifyLockScreen());
        results.Add(VerifyScreenSaver(username));
  results.Add(VerifySleep());
    results.Add(VerifyRdpTimeouts());

        return results;
    }

    /// <summary>
    /// Verify Auto Login configuration for specific user
    /// </summary>
    /// <param name="expectedUsername">Username that should be configured for auto login</param>
    public VerificationResult VerifyAutoLogin(string? expectedUsername = null)
    {
        try
        {
            var winlogonPath = @"SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon";

         using (var key = Registry.LocalMachine.OpenSubKey(winlogonPath))
            {
 if (key == null)
            {
  return new VerificationResult
       {
  Setting = "Auto Login",
  IsConfigured = false,
         Status = "ERROR",
           Details = "Cannot access Winlogon registry key"
              };
        }

    var autoAdminLogon = key.GetValue("AutoAdminLogon") as string;
 var username = key.GetValue("DefaultUserName") as string;
         var domain = key.GetValue("DefaultDomainName") as string;
         var password = key.GetValue("DefaultPassword") as string;

          Logger.LogVerbose($"Auto Login Check - AutoAdminLogon: '{autoAdminLogon}', Username: '{username}', Domain: '{domain}', HasPassword: {!string.IsNullOrEmpty(password)}");

   bool isEnabled = autoAdminLogon == "1" &&
        !string.IsNullOrEmpty(username) &&
         !string.IsNullOrEmpty(password);

      // If a specific user was requested, verify it matches
      if (!string.IsNullOrEmpty(expectedUsername) && isEnabled)
                {
string configuredUser = string.IsNullOrEmpty(domain) ? username : $"{domain}\\{username}";
        string cleanExpectedUser = expectedUsername;
        
           // Parse expected username
            if (expectedUsername.Contains('\\'))
{
          var parts = expectedUsername.Split('\\');
    cleanExpectedUser = parts[1];
          }

  // Compare usernames (case-insensitive)
  bool userMatches = username?.Equals(cleanExpectedUser, StringComparison.OrdinalIgnoreCase) ?? false;
            
  if (!userMatches)
         {
            return new VerificationResult
        {
            Setting = "Auto Login",
           IsConfigured = false,
       Status = "WRONG USER",
       Details = $"Expected: {expectedUsername}, Configured: {configuredUser}"
  };
        }

   Logger.LogVerbose($"Auto login configured for correct user: {configuredUser}");
          }

             return new VerificationResult
        {
        Setting = "Auto Login",
          IsConfigured = isEnabled,
                Status = isEnabled ? "ENABLED" : "DISABLED",
     Details = isEnabled ? $"User: {domain}\\{username}" : $"AutoAdminLogon='{autoAdminLogon}', Username='{username}'"
    };
            }
        }
        catch (Exception ex)
        {
            Logger.LogError("Error verifying auto login", ex);
    return new VerificationResult
            {
     Setting = "Auto Login",
        IsConfigured = false,
      Status = "ERROR",
   Details = ex.Message
    };
   }
    }

    /// <summary>
    /// Verify Lock Screen configuration
    /// </summary>
    public VerificationResult VerifyLockScreen()
    {
  try
 {
            var results = new List<string>();
      bool noLockScreenSet = false;
   bool disableLockSet = false;

            // Check NoLockScreen
  var personalizationPath = @"SOFTWARE\Policies\Microsoft\Windows\Personalization";
      using (var key = Registry.LocalMachine.OpenSubKey(personalizationPath))
      {
    var noLockScreen = key?.GetValue("NoLockScreen");
      noLockScreenSet = noLockScreen?.ToString() == "1";
                results.Add($"NoLockScreen={noLockScreen?.ToString() ?? "not set"}");
   }

  // Check DisableLockWorkstation
       var systemPath = @"SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System";
   using (var key = Registry.LocalMachine.OpenSubKey(systemPath))
            {
           var disableLock = key?.GetValue("DisableLockWorkstation");
         disableLockSet = disableLock?.ToString() == "1";
        results.Add($"DisableLockWorkstation={disableLock?.ToString() ?? "not set"}");
   }

  bool isConfigured = noLockScreenSet && disableLockSet;

            return new VerificationResult
   {
        Setting = "Lock Screen",
            IsConfigured = isConfigured,
       Status = isConfigured ? "DISABLED" : "PARTIALLY DISABLED",
      Details = string.Join(", ", results)
         };
        }
    catch (Exception ex)
        {
 Logger.LogError("Error verifying lock screen", ex);
         return new VerificationResult
  {
              Setting = "Lock Screen",
         IsConfigured = false,
                Status = "ERROR",
     Details = ex.Message
         };
      }
    }

    /// <summary>
    /// Verify Screen Saver configuration for specific user
    /// </summary>
    /// <param name="username">Username to verify (can include domain: DOMAIN\Username)</param>
    public VerificationResult VerifyScreenSaver(string? username = null)
    {
        try
        {
  RegistryKey? key = null;
            string userContext = "Current User";

            if (!string.IsNullOrEmpty(username))
            {
     // Try to get the user's SID and check their registry
         var userSid = GetUserSid(username);
                if (!string.IsNullOrEmpty(userSid))
                {
   try
      {
     var userDesktopPath = $@"{userSid}\Control Panel\Desktop";
  key = Registry.Users.OpenSubKey(userDesktopPath);
        userContext = username;
 Logger.LogVerbose($"Checking screen saver for user: {username} (SID: {userSid})");
   }
         catch (Exception ex)
       {
             Logger.LogVerbose($"Could not access user-specific registry, falling back to current user: {ex.Message}");
         }
        }
      }

  // Fall back to current user if user-specific check failed
            if (key == null)
     {
      var desktopPath = @"Control Panel\Desktop";
 key = Registry.CurrentUser.OpenSubKey(desktopPath);
  userContext = "Current User (fallback)";
            }

   using (key)
 {
        if (key == null)
          {
    return new VerificationResult
          {
         Setting = "Screen Saver",
             IsConfigured = false,
      Status = "ERROR",
       Details = $"Cannot access Desktop registry key for {userContext}"
           };
       }

     var screenSaveActive = key.GetValue("ScreenSaveActive") as string;
        var screenSaveTimeout = key.GetValue("ScreenSaveTimeout") as string;
 var screenSaverIsSecure = key.GetValue("ScreenSaverIsSecure") as string;

                bool isDisabled = screenSaveActive == "0" || screenSaveTimeout == "0";

       return new VerificationResult
        {
 Setting = "Screen Saver",
          IsConfigured = isDisabled,
           Status = isDisabled ? "DISABLED" : "ENABLED",
      Details = $"User: {userContext}, Active={screenSaveActive}, Timeout={screenSaveTimeout}, Secure={screenSaverIsSecure}"
      };
      }
        }
        catch (Exception ex)
{
         Logger.LogError("Error verifying screen saver", ex);
            return new VerificationResult
{
       Setting = "Screen Saver",
    IsConfigured = false,
         Status = "ERROR",
     Details = ex.Message
  };
        }
    }

    /// <summary>
    /// Verify Sleep configuration
 /// </summary>
    public VerificationResult VerifySleep()
    {
        try
        {
            // Get power configuration using powercfg
            var startInfo = new ProcessStartInfo
    {
    FileName = "powercfg",
              Arguments = "/query",
          RedirectStandardOutput = true,
         UseShellExecute = false,
            CreateNoWindow = true
      };

            using var process = Process.Start(startInfo);
         if (process != null)
      {
            var output = process.StandardOutput.ReadToEnd();
      process.WaitForExit();

         // Parse output for sleep settings
                bool hasAcSleep = output.Contains("Hibernate After (seconds): 0") ||
          output.Contains("Sleep After (seconds): 0");

              return new VerificationResult
         {
        Setting = "Sleep & Hibernate",
              IsConfigured = hasAcSleep,
        Status = hasAcSleep ? "DISABLED" : "CHECK MANUALLY",
          Details = "Use 'powercfg /query' to verify settings"
            };
    }

            return new VerificationResult
   {
     Setting = "Sleep & Hibernate",
        IsConfigured = false,
     Status = "UNKNOWN",
       Details = "Unable to query power settings"
            };
        }
      catch (Exception ex)
        {
         Logger.LogError("Error verifying sleep settings", ex);
            return new VerificationResult
     {
   Setting = "Sleep & Hibernate",
    IsConfigured = false,
         Status = "ERROR",
 Details = ex.Message
            };
        }
    }

    /// <summary>
    /// Verify RDP Timeout configuration
    /// </summary>
    public VerificationResult VerifyRdpTimeouts()
    {
  try
  {
            var terminalServicesPath = @"SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services";
      using (var key = Registry.LocalMachine.OpenSubKey(terminalServicesPath))
            {
        if (key == null)
 {
           return new VerificationResult
        {
        Setting = "RDP Timeouts",
          IsConfigured = false,
    Status = "NOT CONFIGURED",
           Details = "Terminal Services policy key does not exist"
 };
          }

   var maxIdleTime = key.GetValue("MaxIdleTime");
    var maxDisconnectionTime = key.GetValue("MaxDisconnectionTime");
    var maxConnectionTime = key.GetValue("MaxConnectionTime");

       bool isDisabled = (maxIdleTime?.ToString() == "0") &&
       (maxDisconnectionTime?.ToString() == "0") &&
     (maxConnectionTime?.ToString() == "0");

          return new VerificationResult
     {
 Setting = "RDP Timeouts",
     IsConfigured = isDisabled,
           Status = isDisabled ? "DISABLED" : "ENABLED",
   Details = $"Idle={maxIdleTime}, Disconnected={maxDisconnectionTime}, Connection={maxConnectionTime}"
          };
            }
   }
        catch (Exception ex)
        {
       Logger.LogError("Error verifying RDP timeouts", ex);
          return new VerificationResult
    {
         Setting = "RDP Timeouts",
    IsConfigured = false,
             Status = "ERROR",
 Details = ex.Message
            };
        }
    }

    /// <summary>
    /// Get user SID from username
    /// </summary>
    private string? GetUserSid(string username)
 {
        try
        {
  // Remove domain prefix if present
    var cleanUsername = username.Contains('\\') ? username.Split('\\')[1] : username;

        var profileListPath = @"SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList";
    using var profileList = Registry.LocalMachine.OpenSubKey(profileListPath);

            if (profileList != null)
  {
       foreach (var sidString in profileList.GetSubKeyNames())
           {
      using var profileKey = profileList.OpenSubKey(sidString);
       if (profileKey != null)
       {
    var profilePath = profileKey.GetValue("ProfileImagePath") as string;
    if (profilePath != null && profilePath.EndsWith(cleanUsername, StringComparison.OrdinalIgnoreCase))
      {
       Logger.LogVerbose($"Found SID for user {username}: {sidString}");
            return sidString;
          }
           }
            }
 }
  }
        catch (Exception ex)
  {
 Logger.LogVerbose($"Error finding SID for user {username}: {ex.Message}");
        }

        return null;
    }

    /// <summary>
    /// Generate detailed report for specific user
    /// </summary>
  /// <param name="username">Username to verify (optional)</param>
    public string GenerateReport(string? username = null)
    {
        var results = VerifyAllSettings(username);
    var report = "===== SYSTEM CONFIGURATION VERIFICATION =====\n";
        
        if (!string.IsNullOrEmpty(username))
        {
         report += $"User: {username}\n";
        }
        
    report += "\n";

   foreach (var result in results)
        {
        var icon = result.IsConfigured ? "✓" : "✗";
            var statusColor = result.IsConfigured ? "OK" : "NEEDS ATTENTION";

            report += $"{icon} {result.Setting}\n";
            report += $"   Status: {result.Status}\n";
   report += $"   Details: {result.Details}\n\n";
        }

        var successCount = results.Count(r => r.IsConfigured);
        var totalCount = results.Count;

        report += $"===== SUMMARY =====\n";
        report += $"Configured: {successCount}/{totalCount}\n";
        report += $"Completion: {(successCount * 100 / totalCount)}%\n";

     return report;
    }
}
