using HuLoopBOT.Services;
using HuLoopBOT.Utilities;
using System.Diagnostics;

namespace HuLoopBOT;

public partial class MainForm : Form
{
    private readonly bool _isAdmin;

    public MainForm()
    {
        InitializeComponent();
      
        _isAdmin = AdminService.IsAdmin();
        
        UpdateAdminStatus();
        ConfigureButtonsForPrivilegeLevel();
    }

  private void UpdateAdminStatus()
  {
        if (_isAdmin)
  {
     lblAdminStatus.Text = "✓ Running as Administrator";
    lblAdminStatus.ForeColor = Color.Green;
  }
        else
 {
          lblAdminStatus.Text = "⚠ Not Administrator - Limited Features";
   lblAdminStatus.ForeColor = Color.Orange;
  }
    }

    private void ConfigureButtonsForPrivilegeLevel()
    {
   if (!_isAdmin)
        {
       // Disable operation buttons for non-admin users
   btnDisableSleep.Enabled = false;
       btnDisableLock.Enabled = false;
  btnPreventRdpTimeout.Enabled = false;
            btnTransferSession.Enabled = false;

 // Update button text to show admin required
  btnDisableSleep.Text = "Disable Sleep (Admin Required)";
  btnDisableLock.Text = "Disable Lock Screen (Admin Required)";
       btnPreventRdpTimeout.Text = "Prevent RDP Timeout (Admin Required)";
    btnTransferSession.Text = "Transfer Session (Admin Required)";
   
      Logger.LogInformation("UI loaded in non-admin mode - operations disabled");
  }
        else
 {
            Logger.LogInformation("UI loaded in admin mode - all operations enabled");
        }
    }

    private void btnDisableSleep_Click(object sender, EventArgs e)
    {
  if (!_isAdmin)
    {
      ShowAdminRequiredMessage();
   return;
   }

try
   {
   var result = new PowerService().DisableSleep();
       ShowResult(result.Success, result.Message);
      }
     catch (Exception ex)
     {
     Logger.LogError("Error in btnDisableSleep_Click", ex);
      ShowResult(false, $"Error: {ex.Message}");
   }
    }

    private void btnDisableLock_Click(object sender, EventArgs e)
    {
 if (!_isAdmin)
   {
      ShowAdminRequiredMessage();
     return;
    }

        try
 {
var result = new LockService().DisableLockScreen();
      ShowResult(result.Success, result.Message);
   }
        catch (Exception ex)
   {
   Logger.LogError("Error in btnDisableLock_Click", ex);
    ShowResult(false, $"Error: {ex.Message}");
        }
    }

    private void btnPreventRdpTimeout_Click(object sender, EventArgs e)
    {
  if (!_isAdmin)
      {
   ShowAdminRequiredMessage();
       return;
   }

        try
        {
   var result = new RdpService().PreventTimeout();
            ShowResult(result.Success, result.Message);
        }
        catch (Exception ex)
{
          Logger.LogError("Error in btnPreventRdpTimeout_Click", ex);
     ShowResult(false, $"Error: {ex.Message}");
        }
    }

    private void btnTransferSession_Click(object sender, EventArgs e)
    {
        if (!_isAdmin)
     {
       ShowAdminRequiredMessage();
   return;
        }

        try
 {
     var result = new SessionTransferService().Transfer(1);
  ShowResult(result.Success, result.Message);
        }
        catch (Exception ex)
        {
Logger.LogError("Error in btnTransferSession_Click", ex);
 ShowResult(false, $"Error: {ex.Message}");
  }
    }

    private void ShowResult(bool success, string message)
  {
        var icon = success ? MessageBoxIcon.Information : MessageBoxIcon.Error;
        var title = success ? "Success" : "Error";
  
        Logger.Log(message);
  MessageBox.Show(message, title, MessageBoxButtons.OK, icon);
    }

    private void ShowAdminRequiredMessage()
    {
        var result = MessageBox.Show(
   "Administrator privileges are required for this operation.\n\n" +
   "Would you like to restart the application as Administrator?",
   "Administrator Required",
   MessageBoxButtons.YesNo,
    MessageBoxIcon.Warning);

        if (result == DialogResult.Yes)
   {
   RestartAsAdmin();
        }
    }

    private void RestartAsAdmin()
 {
   try
  {
  Logger.LogInformation("User requested to restart application with elevated privileges");
      
       var psi = new ProcessStartInfo
   {
     FileName = Application.ExecutablePath,
  UseShellExecute = true,
       Verb = "runas"
 };

  Logger.LogVerbose($"Starting elevated process: {psi.FileName}");
            
      Process.Start(psi);
      
   Logger.LogInformation("Elevated process started, closing current instance");
   Application.Exit();
        }
  catch (System.ComponentModel.Win32Exception ex)
        {
     if (ex.NativeErrorCode == 1223) // User cancelled UAC
        {
             Logger.LogWarning("User cancelled UAC elevation prompt");
     MessageBox.Show(
    "Elevation cancelled. The application will continue in limited mode.",
       "Cancelled",
     MessageBoxButtons.OK,
  MessageBoxIcon.Information);
   }
      else
      {
     Logger.LogError($"Failed to restart as admin. Error Code: {ex.NativeErrorCode}", ex);
   MessageBox.Show(
      $"Failed to restart with elevated privileges.\n\nError: {ex.Message}",
  "Error",
       MessageBoxButtons.OK,
MessageBoxIcon.Error);
    }
  }
        catch (Exception ex)
   {
         Logger.LogError("Unexpected error during restart as admin", ex);
     MessageBox.Show(
              $"An unexpected error occurred:\n\n{ex.Message}",
 "Error",
  MessageBoxButtons.OK,
       MessageBoxIcon.Error);
     }
    }
}
